---
title:  "μ¤λ§νΈ ν¬μΈν„° / unique_ptr μ λ‹ν¬ ν¬μΈν„°"

categories:
  - Cpp
tags:
  - [Cpp, C++, pointer, smart pointer, unique_ptr]

toc: true
toc_sticky: true
 
date: 2023-12-26
last_modified_at: 2023-12-26
---

<br>

> π¤― μ–Έλ¦¬μ–Όμ„ ν•κΈ° μ„ν•΄ C++ κΈ°μ–µ λμ‚΄λ¦¬κΈ° ν”„λ΅μ νΈ

# μ¤λ§νΈ ν¬μΈν„°

- unique_ptr
  - μ§„μ§ λ§μ΄ μ”€! μ¤‘μ”!
- shared_ptr
  - λ°‘μ weakμ™€ λ¬¶μ—¬μ„ μ“°μ„.
- weak_ptr



```cpp
// μμ‹: ν¬μΈν„°
#include "Vector.h"

int main()
{
    Vector* myVector = new Vector(10f, 30.f);

    // ...

    delete myVector;

    return 0;
}
```

μ΄λ ‡κ² new λ΅ ν• λ‹Ήμ„ ν•΄μ¤¬μΌλ©΄ deleteλ΅ μ§€μ›μ¤μ•Ό ν•¨.  
κ·Έλ°λ° μ¤‘κ°„μ— λ°ν™μ„ ν•΄λ²„λ¦¬λ” κ²½μ° deleteκΉμ§€ μ½”λ“κ°€ κ°€μ§€ μ•μ•„  
λ©”λ¨λ¦¬κ°€ λ„μκ°€ λ°μƒν•λ” κ²½μ°κ°€ μμ„ μ μμ.  

> π’΅ μ¤λ§νΈ ν¬μΈν„°λ¥Ό μ“°λ©΄, deleteλ¥Ό μ§μ ‘ νΈμ¶ν•  ν•„μ”κ°€ μ—†λ‹¤!  
> κ·Έλ¦¬κ³  κ°€λΉ„μ§€ μ»¬λ ‰μ…λ³΄λ‹¤ λΉ λ¥΄λ‹¤!  
> ( μ“°μ΄μ§€ μ•λ” μκ°„μ— λ”± μ§€μ›μ§€κΈ° λ•λ¬Έμ—. )

## 1. unique_ptr

ν¬μΈν„° μ†μ μκ°€ ν•λ‚ λ°–μ— μ—†λ‹¤.  
λ‚ λ§κ³  λ„κµ¬λ„ λ»μ“°κ² λ§λ“λ” ν¬μΈν„°.  
μ†μ μκ°€ ν• λ…μ΄λ©΄ κ·Έ μ‚¬λμ΄ μ§€μ°λ©΄ λλ‹¤.  

```cpp
#include <memory>
#include "Vector.h"

int main()
{
    std::unique_ptr<Vector> myVector(new Vector(10.f, 30.f));
    // ν¬μΈν„° λ¶€νΈκ°€ μ—†μ!

    myVector->Print();
    // κ·Έλ¬λ‚ ν¬μΈν„°μ²λΌ λ™μ‘ν•  μ μμ.
    // κ·Έλ¦¬κ³  deleteκ°€ μ—†μ.

    return 0;
}
```

- ν¬μΈν„°(μ›μ‹ ν¬μΈν„°? κΈ°μ΅΄ ν¬μΈν„°?) λ¥Ό λ‹¨λ…μΌλ΅ μ†μ 
- μ†μ ν• μ›μ‹ ν¬μΈν„°λ” λ„κµ¬ν•κ³ λ„ κ³µμ λμ§€ μ•μ•μ
  - λ”°λΌμ„ <b>λ³µμ‚¬λ‚ λ€μ… λ¶κ°€λ¥!</b>
- unique_ptrκ°€ λ²”μ„(scope)λ¥Ό λ²—μ–΄λ‚  λ•, μ›μ‹ ν¬μΈν„°λ” μ§€μ›μ§ (delete)
  ```cpp
  std::unique_ptr<Vector> myVector(new Vector(10.f, 30.f));

  std::unique_ptr<Vector> copiedVector1 = myVector;         // μ»΄νμΌ μ—λ¬! μ λ‹ν¬ ν¬μΈν„° λ€μ… μ• λ¨.
  std::unique_ptr<Vector> copiedVector2(myVector);          // μ»΄νμΌ μ—λ¬! μ λ‹ν¬ ν¬μΈν„° λ³µμ‚¬ λ» ν•¨.
  ```

## 2. μ λ‹ν¬ ν¬μΈνΈκ°€ μ ν•©ν• 3κ°€μ§€ κ²½μ°

### μμ‹1: ν΄λμ¤μ—μ„ μƒμ„±μ/μ†λ©Έμ

```cpp
// OLD
// Player.h
class Player
{
    private:
        Vector* mLocation;
};

// Player.cpp
Player::Player(std::string name)
        : mLocation(new Vector())
{

}

Player::~Player()
{
    delete mLocation;           // μ†λ©Έμμ—μ„ μ§€μ›μ¤¬μ–΄μ•Ό ν–μ
}
```

```cpp
// NEW!
// Player.h
class Player
{
    private:
        std::unique_ptr<Vector> mLocation;
};

// Player.cpp
Player::Player(std::string name)
        : mLocation(new Vector())
{

}

// μ†λ©Έμμ— delete ν‚¤μ›λ“ μ• μ”€!
// Player μ†λ©Έλ  λ• μ•μ•„μ„ μ§€μ›μ§.
```

### μμ‹2: μ§€μ—­ λ³€μ

```cpp
// OLD
#include "Vector.h"
int main()
{
    Vector* vector = new Vector(10.f, 30.f);

    vector ->Print();

    delete vector;
}
```

```cpp
// NEW!
#include "Vector.h"
#include <memory>
int main()
{
    std::unique_ptr<Vector> vector(new Vector(10.f, 30.f));

    vector ->Print();
}
```

### μμ‹3: STL λ²΅ν„°μ— ν¬μΈν„° μ €μ¥ν•κΈ°

```cpp
// OLD
#include <vector>
#include "Player.h"

int main()
{
    std::vector<Player*> players;
    players.push_back(new Player("Lulu"));
    players.push_back(new Player("Coco"));

    for (int i = 0; i < players.size(); ++i)
    {
        delete players[i];
    }

    players.clear();
    // ...
}
```

```cpp
// NEW!
#include <vector>
#include "Player.h"

int main()
{
    std::vector<std::unique_ptr<Player>> playerList;

    playerList.push_back(std::unique_ptr<Player>(new Player("Lulu")));
    playerList.push_back(std::unique_ptr<Player>(new Player("Coco")));

    players.clear();
    // ν΄λ¦¬μ–΄ ν•λ©΄μ„ μ†λ©Έμ νΈμ¶λλ©° λ‹¤ μ§€μ›μ§.

    // μ‚¬μ‹¤ κµ³μ΄ clearνΈμ¶ μ• ν•΄λ„ λ¨.
    // main() μ¤μ½”ν”„ λ‚κ°€λ©΄μ„ vector μ†λ©Έμ λ¶λ¬μ¤κ² λ¨.
    // μμ²΄μ μΌλ΅ clear νΈμ¶λλ©΄μ„ μ§€μ›μ§.
    // ...
}
```

## 3. μ λ‹ν¬ ν¬μΈν„° λ§λ“¤κΈ° (C++14 μ΄ν›„)

### λ¬Έμ : μ›μ‹ ν¬μΈν„° κ³µμ 

```cpp
Vector* vectorPtr = new Vector(10.f, 30.f);         // μ›μ‹ ν¬μΈν„° μƒμ„±
std::unique_ptr<Vector> vector(vectorPtr);
// λ€μ…ν•΄μ„ λ„£μ–΄μ¤

std::unique_ptr<Vector> anotherVector(vectorPtr);
// λ€μ…ν•΄μ„ λ„£μ–΄μ¤ 2. μ›μ‹ ν¬μΈν„°λΌ μ λ‹ν¬ ν¬μΈν„°μ— λ€μ… κ°€λ¥ ν•¨ γ…;;
// κ°™μ€ ν¬μΈν„°λ¥Ό λ λ„£μ–΄μ£Όκ² λ κ²ƒ. μ†μ μ κ¶ν• κ°λ…μ΄ κΉ¨μ§!
// κ·Έλμ„ nullptrμ„ λ€μ…ν•μ—¬ μ—†μ• λ²„λ¦΄ μμ •.

anotherVector = nullptr;            // μ΄κ±° μ—°μ‚°μ μ¤λ²„λ΅λ”©μ„
// κ·Έ.λ¬.λ‚.
// μ΄κ±΄ μ λ‹ν¬ ν¬μΈν„°κ°€ nullμ΄ λλ”κ² μ•„λ‹λΌ, κ·Έ μ•μ— μλ” μ›μ‹ ν¬μΈν„°λ¥Ό nullλ΅ ν•΄μ£Όλ” κ²ƒ.
// ν¬μΈν„°μ— λ€ν• μ†μ κ¶μ„ λ†“λ” κ²ƒμ΄λ―€λ΅, μλ™μΌλ΅ μ†λ©Έμ νΈμ¶

// κ²°κµ­ anotherVectorλ” emptyκ°€ λλ²„λ¦¬κ³ ,
// vectorPtr κ°’μ΄ λ‚ μ•„κ°€κ² λ¨.
// κ·Έλ°λ° vectorλ” μ•„μ§λ„ λ³ΈμΈμ΄ ν¬μΈν„°λ¥Ό μ λ€λ΅ κ°–κ³ μλ” μ¤„ μ•.

// κ·Έλμ„ λ‚μ¤‘μ— vectorκ°€ μ†λ©Έλ  λ• μ†λ©Έμλ¥Ό νΈμ¶ν•κ² λκ³ ,
// vectorPtrλ” μ΄λ―Έ λ‚ λΌκ°”μΌλ―€λ΅ μ—λ¬κ°€ λ°μƒν•κ² λ  κ²ƒ...
```

### ν•΄κ²°μ±… (C++14 μ΄ν›„) : make_unique

```cpp
#include <memory>
#include "Vector.h"

int main()
{
    std::unique_ptr<Vector> myVector = std::make_unique<Vector>(10.f, 30.f);

    myVector->Print();

    return 0;
}
```

- std::make_unique()κ°€ λ¬΄μ¨ μΌμ„ ν• κΉ?
  - μ£Όμ–΄μ§„ λ§¤κ°λ³€μμ™€ μλ£ν•μΌλ΅ new ν‚¤μ›λ“ νΈμ¶ν•΄μ¤
  - λ‘ μ΄μƒμ μ λ‹ν¬ ν¬μΈν„°κ°€ μ›μ‹ ν¬μΈν„°λ¥Ό κ³µμ ν•  μ μ—†λ„λ΅ λ§‰μ•„μ¤

### λ§λ“¤κΈ° μμ‹

```cpp
Vector* vectorPtr = new Vector(10.f, 30.f);

// μ‹Ή λ‹¤ μ—λ¬λ‚¨!
std::unique_ptr<Vector> vector1 = std::make_unique(vectorPtr);
std::unique_ptr<Vector> vector2 = std::make_unique<Vector>(vectorPtr);
std::unique_ptr<Vector> vector3 = std::make_unique<Vector*>(10.f, 30.f);

// C++11
std::unique_ptr<Vector> vector(new Vector(10.f, 30.f));
std::unique_ptr<Vector[]> vectors(new Vector[20]);

// C++14 (μ΄λ ‡κ² μ“°μ)
std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);
std::unique_ptr<Vector[]> vectors = std::make_unique<Vector[]>(20);
```


#### μ λ‹ν¬ ν¬μΈν„° μ¬μ„¤μ • : reset()

```cpp
int main()
{
    std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);
    vector.reset(new Vector(20.f, 40.f));
    vector.reset();                         // μ΄κ±΄ nullptr λ€μ…ν•λ” κ±°λ‘ κ°™λ‹¤!
    // ...
}
```
- reset()μ„ νΈμ¶ν•λ©΄ ν¬μΈν„°λ¥Ό κµμ²΄ν•λ‹¤
- μ¬μ„¤μ • λ  λ•, μ†μ ν•κ³  μλ μ›μ‹ ν¬μΈν„°λ” μλ™μΌλ΅ μ†λ©Έ λλ‹¤!
- nullptrμ„ κΌ­ μ¨μ•Ό ν• κΉ?
  - μ•„λ‹λ‹¤. λ‘ μ½”λ“λ” κ°™μ (`vector = nullptr;`, `vector.reset();`)
  - nullptrμ΄ reset()κ³Ό κ°€λ…μ„±μ΄ λ” λ†’κΈ΄ ν•¨
  - κ·Έλ¬λ‚ reset()μ€ vectorκ°€ μ›μ‹ ν¬μΈν„°κ°€ μ•„λ‹μ„ ν™•μ‹¤ν λ³΄μ—¬μ¤


#### μ λ‹ν¬ ν¬μΈν„° κ°€μ Έμ¤κΈ° : get()

μ λ‹ν¬ ν¬μΈν„° μ•μ ν¬μΈν„°λ¥Ό λ°›κΈΈ μ›ν•  λ•. (μ›μ‹ ν¬μΈν„°)  
μ λ‹ν¬ ν¬μΈν„°λ” λ³ΈμΈμ΄ μ†μ ν•κ³  μλ” κ±°λ‹κΉ,  
κ·Έ μ•μ μ›μ‹ ν¬μΈν„°λ¥Ό λ°–μΌλ΅ μ¤„ λ• μ›μ‹ ν¬μΈν„°λ¥΄ μ£Όλ” κ² λ‚μμ§€ μ•λ‹¤!...  

```cpp
// Vector.cpp
void Vector::Add(const Vector* other)
{
  mX += other->mX;
  mY += other->mY;
}

// -----------------------------------------
#include <memory>
#include "Vector.h"

int main()
{
  std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);
  std::unique_ptr<Vector> anotherVector = std::make_unique<Vector>(20.f, 40.f);

  vector->Add(anotherVector.get());     // <- μ΄λ ‡κ²!
  vector->Print();

  return 0;
}
```

- μ›μ‹ ν¬μΈν„°λ¥Ό λ°ν™ν•λ‹¤



#### μ›μ‹ ν¬μΈν„° μ†μ κ¶ λ°•νƒν•κΈ° : release()

μ›μ‹ ν¬μΈν„°λ¥Ό <b>μ§€μ°μ§€ μ•κ³ </b> μ†μ κ¶μ„ λ†“μ•„μ¤€λ‹¤.  
κ·Όλ° μΆ‹μ€ ν•¨μλ” μ•„λ‹... λ‚μ¤‘μ— μ§€μ°λ” κ±Έ μ²΄ν¬ν•΄μ•Ό ν•λ‹κΉ.  
μ°¨λΌλ¦¬ μ λ‹ν¬ ν¬μΈν„°κ°€ κ°–κ² λ‘κ³  μ•μ•„μ„ μ§€μ›μ§€κ² λ‘λ”κ² λ‚«λ‹¤λ” λ§.  

```cpp
int main()
{
  std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);
  Vector* vectorPtr = vector.release();     // <- μ΄λ ‡κ²!
  // ...
}
```

- μ›μ‹ ν¬μΈν„°μ— λ€ν• μ†μ κ¶μ„ λ°•νƒν•κ³  μ›μ‹ ν¬μΈν„° λ°ν™
- `release()` νΈμ¶ ν›„ `get()` μ„ νΈμ¶ν•λ©΄ nullptr λ°ν™
  ```cpp
  // vectorλ” μ λ‹ν¬ ν¬μΈν„°!
  Vector* vectorPtr = vector.release();
  Vector* vectorPtr2 = vector.get();          // nullptr λ°ν™
  ```



#### μ λ‹ν¬ ν¬μΈν„° μ†μ κ¶ μ΄μ „ν•κΈ° : std::move()  

```cpp
#include <memory>
#include "Vector.h"

int main()
{
  std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);
  std::unique_ptr<Vector> anotherVector(std::move(vector));     // <- μ΄κ±°!
}
```

μ„ ν•¨μκ°€ μ‹¤ν–‰λλ©΄,  
`vector`λ” μ†μ κ¶μ„ μƒμ—μΌλ‹κΉ null μ΄ λλ²„λ¦¬κ³ ,  
`anotherVector` λ” vectorκ°€ κ°–κ³ μλ μ›μ‹ ν¬μΈν„°μ μ†μ κ¶μ„ κ°–κ² λ¨.  

- `std::unique_ptr` μ€ μ†μ ν• μ›μ‹ ν¬μΈν„°λ¥Ό μ•„λ¬΄ν•κ³ λ„ κ³µμ ν•μ§€ μ•μ
- μ¦‰, μ£Όμ† λ³µμ‚¬λ¥Ό ν•μ§€ μ•λ”λ‹¤λ” λ»
- λ€μ‹ , μ†μ κ¶μ„ λ‹¤λ¥Έ `std::unique_ptr` λ΅ μ®κΈΈ μ μμ -> `std::move`
  - `std::move` λ¥Ό μ‚¬μ©ν•  κ²½μ° λ©”λ¨λ¦¬ ν• λ‹Ή/ν•΄μ κ°€ μΌμ–΄λ‚μ§„ μ•μ
- μμ™Έ : `const std::unique_ptr`

##### μμ‹: const μ λ‹ν¬ ν¬μΈν„°λ” μ–΄λ–¨κΉ?

```cpp
const std::unique_ptr<Vector> vector = std::make_unique<Vector>(10.f, 30.f);

std::unique_ptr<Vector> anotherVector(std::move(vector));   // <- μ»΄νμΌ μ—λ¬!
```

const λ‹κΉ λ‹Ήμ—°ν λ°”λ€” μ μ—†λ‹¤... κ·Έλμ„ μ—λ¬.  



## 4. μ λ‹ν¬ ν¬μΈν„° ν•΄λ¶€

```cpp
template<typename T>                          // μ λ‹ν¬ ν¬μΈν„° μ•„λ¬΄κ±°λ‚ λ°›λ„λ΅ ν…ν”λ¦Ών™”
class unique_ptr<T> final                     // μƒμ† μ•λλ„λ΅ final
{
  public:
    unique_ptr(T* ptr) : mPtr(ptr) {}         // μ›μ‹ ν¬μΈν„° λ°›λ” μƒμ„±μ. ν¬μΈν„° λ³€μμ— μ €μ¥ν•κ² λ‹¤!
    ~unique_ptr() { delete mPtr; }            // μ§€μΈ λ•. ν¬μΈν„° λ³€μ μ§€μ΄λ‹¤!
    T* get() { return mPtr; }                 // μ›μ‹ ν¬μΈν„° λ°ν™ν•λ” ν•¨μ get(). ν¬μΈν„° λ³€μ λ°ν™.
    unique_ptr(const unique_ptr&) = delete;   // λ³µμ‚¬ μ•λλ„λ΅ λ³µμ‚¬ μƒμ„±μ μ§€μ›€.
    unique_ptr& operator=(const unique_ptr&) = delete;  // λ€μ… μ•λλ„λ΅ λ€μ… μ—°μ‚°λ„ μ§€μ›€.
  private:
    T* mPtr = nullptr;                        
}
```